name: Release Build (Signed)

# This workflow is for creating signed releases when you have Apple Developer certificates
# You'll need to add the following secrets to your GitHub repository:
# - APPLE_CERTIFICATE_BASE64: Base64 encoded .p12 certificate
# - APPLE_CERTIFICATE_PASSWORD: Password for the .p12 certificate
# - APPLE_PROVISIONING_PROFILE_BASE64: Base64 encoded provisioning profile
# - APPLE_TEAM_ID: Your Apple Developer Team ID

on:
  push:
    tags:
      - 'v*.*.*-signed'  # Triggers on signed version tags like v1.0.0-signed
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  release-signed:
    name: Build Signed Release
    runs-on: macos-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Import signing certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=${{ runner.temp }}/certificate.p12
          KEYCHAIN_PATH=${{ runner.temp }}/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          # Decode certificate
          echo -n "$CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Import certificate to keychain
          security import $CERTIFICATE_PATH \
            -P "$CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Import provisioning profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          PP_PATH=${{ runner.temp }}/profile.mobileprovision
          echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode -o $PP_PATH
          
          # Install provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Set version number
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            VERSION="${VERSION%-signed}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          BUILD_NUMBER=$(date +%Y%m%d%H%M)
          echo "BUILD_NUMBER=${BUILD_NUMBER}" >> $GITHUB_ENV

      - name: Build and archive
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcodebuild clean archive \
            -scheme SimpleHomeAssistant \
            -sdk iphoneos \
            -configuration Release \
            -archivePath ${{ runner.temp }}/SimpleHomeAssistant.xcarchive \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            MARKETING_VERSION=${{ env.VERSION }} \
            CURRENT_PROJECT_VERSION=${{ env.BUILD_NUMBER }}

      - name: Export IPA
        run: |
          # Create export options plist
          cat > ${{ runner.temp }}/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>ad-hoc</string>
            <key>teamID</key>
            <string>${{ secrets.APPLE_TEAM_ID }}</string>
            <key>compileBitcode</key>
            <false/>
            <key>stripSwiftSymbols</key>
            <true/>
          </dict>
          </plist>
          EOF
          
          # Export archive to IPA
          xcodebuild -exportArchive \
            -archivePath ${{ runner.temp }}/SimpleHomeAssistant.xcarchive \
            -exportPath ${{ runner.temp }}/export \
            -exportOptionsPlist ${{ runner.temp }}/ExportOptions.plist
          
          # Rename IPA
          mv ${{ runner.temp }}/export/SimpleHomeAssistant.ipa \
             ${{ runner.temp }}/SimpleHomeAssistant-${{ env.VERSION }}-signed.ipa

      - name: Upload signed IPA
        uses: actions/upload-artifact@v4
        with:
          name: SimpleHomeAssistant-${{ env.VERSION }}-signed
          path: ${{ runner.temp }}/SimpleHomeAssistant-${{ env.VERSION }}-signed.ipa
          retention-days: 90

      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ runner.temp }}/SimpleHomeAssistant-${{ env.VERSION }}-signed.ipa
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## HAbitat iOS v${{ env.VERSION }} (Signed Release)
            
            ### Installation
            This is a **signed** release. Installation options:
            1. **TestFlight**: Upload to App Store Connect for TestFlight distribution
            2. **Ad-hoc**: Install directly on registered devices
            3. **Enterprise**: If using enterprise certificate, distribute via MDM
            
            ### Requirements
            - iOS 16.0 or later
            - iPhone or iPad
            - Home Assistant instance (local or remote)
            
            ### Features
            - ðŸ  Multi-Configuration Support
            - ðŸ”„ Network Switching (Internal/External URLs)
            - ðŸ“± Universal App (iPhone & iPad)
            - ðŸŽ¨ Custom Tabs for organization
            - âš¡ Real-time Control
            - ðŸ” Secure with HTTP support for local networks
            
            ---
            ðŸ  **HAbitat** - Your home, in your pocket
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up keychain
        if: always()
        run: |
          security delete-keychain ${{ runner.temp }}/app-signing.keychain-db || true

      - name: Build Summary
        run: |
          echo "## Signed Build Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number:** ${{ env.BUILD_NUMBER }}" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:** Release (Signed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Signed IPA ready for distribution!" >> $GITHUB_STEP_SUMMARY
